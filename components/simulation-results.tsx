"use client";

import { useState } from "react";
import { SimulationResults as Results } from "@/lib/simulation";
import jsPDF from "jspdf";

interface SimulationResultsProps {
  results: Results;
  onReset: () => void;
}

export function SimulationResults({ results, onReset }: SimulationResultsProps) {
  const [isGeneratingPDF, setIsGeneratingPDF] = useState(false);

  const generatePDF = () => {
    setIsGeneratingPDF(true);
    
    // Use setTimeout to allow UI to update before blocking operation
    setTimeout(() => {
      const doc = new jsPDF();
    
    // Title
    doc.setFontSize(20);
    doc.text("MVP Simulation Report", 20, 20);
    
    // Startup Info
    doc.setFontSize(12);
    doc.text(`Startup: ${results.input.ideaName}`, 20, 35);
    doc.text(`Target Market: ${results.input.targetMarket}`, 20, 42);
    
    // Verdict
    doc.setFontSize(16);
    const verdictColor = results.verdict === "GO" ? [0, 128, 0] : results.verdict === "MAYBE" ? [255, 165, 0] : [255, 0, 0];
    doc.setTextColor(verdictColor[0], verdictColor[1], verdictColor[2]);
    doc.text(`Verdict: ${results.verdict}`, 20, 55);
    doc.setTextColor(0, 0, 0);
    
    doc.setFontSize(10);
    doc.text(`Confidence Score: ${results.confidenceScore}/100`, 20, 65);
    doc.text(results.verdictReason, 20, 72, { maxWidth: 170 });
    
    // Financial Summary
    doc.setFontSize(14);
    doc.text("Financial Summary (12 Months)", 20, 90);
    doc.setFontSize(10);
    doc.text(`Total Revenue: $${results.totalRevenue12M.toLocaleString()}`, 20, 100);
    doc.text(`Total Costs: $${results.totalCosts12M.toLocaleString()}`, 20, 107);
    doc.text(`Total Profit: $${results.totalProfit12M.toLocaleString()}`, 20, 114);
    doc.text(`Break-even: ${results.breakEvenMonth ? `Month ${results.breakEvenMonth}` : "Not reached"}`, 20, 121);
    
    // Risk Factors
    doc.setFontSize(14);
    doc.text("Risk Factors", 20, 135);
    doc.setFontSize(10);
    let yPos = 145;
    results.riskFactors.forEach(risk => {
      doc.text(`${risk.factor}: ${risk.score}/100 (${risk.impact} Impact)`, 20, yPos);
      yPos += 7;
    });
    
    // Suggestions
    if (results.suggestions.length > 0) {
      doc.setFontSize(14);
      doc.text("Recommendations", 20, yPos + 10);
      doc.setFontSize(10);
      yPos += 20;
      results.suggestions.forEach((suggestion, idx) => {
        doc.text(`${idx + 1}. ${suggestion}`, 20, yPos, { maxWidth: 170 });
        yPos += 10;
      });
    }
    
    // Footer
    doc.setFontSize(8);
    doc.text("Generated by FORMATDISC MVP Simulation Tool", 20, 280);
    doc.text("www.formatdisc.hr | info@formatdisc.hr", 20, 285);
    
    doc.save(`${results.input.ideaName.replace(/\s+/g, '-')}-simulation-report.pdf`);
    setIsGeneratingPDF(false);
    }, 100);
  };

  const verdictColorClass = 
    results.verdict === "GO" ? "text-green-600 bg-green-50 border-green-200" :
    results.verdict === "MAYBE" ? "text-orange-600 bg-orange-50 border-orange-200" :
    "text-red-600 bg-red-50 border-red-200";

  const verdictBadgeClass = 
    results.verdict === "GO" ? "bg-green-500" :
    results.verdict === "MAYBE" ? "bg-orange-500" :
    "bg-red-500";

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8">
        <div className="flex justify-between items-start mb-6">
          <div>
            <h2 className="text-3xl font-bold mb-2">{results.input.ideaName}</h2>
            <p className="text-gray-600 dark:text-gray-400">Target Market: {results.input.targetMarket}</p>
          </div>
          <button
            onClick={onReset}
            className="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition"
          >
            New Simulation
          </button>
        </div>

        {/* Verdict */}
        <div className={`border-2 rounded-lg p-6 ${verdictColorClass}`}>
          <div className="flex items-center gap-4 mb-3">
            <span className={`px-4 py-2 rounded-lg text-white font-bold text-xl ${verdictBadgeClass}`}>
              {results.verdict}
            </span>
            <span className="text-2xl font-bold">Confidence: {results.confidenceScore}/100</span>
          </div>
          <p className="text-lg">{results.verdictReason}</p>
        </div>
      </div>

      {/* Financial Summary */}
      <div className="grid md:grid-cols-4 gap-4">
        <MetricCard title="12M Revenue" value={`$${(results.totalRevenue12M / 1000).toFixed(1)}k`} />
        <MetricCard title="12M Costs" value={`$${(results.totalCosts12M / 1000).toFixed(1)}k`} />
        <MetricCard title="12M Profit" value={`$${(results.totalProfit12M / 1000).toFixed(1)}k`} trend={results.totalProfit12M >= 0} />
        <MetricCard title="Break-even" value={results.breakEvenMonth ? `Month ${results.breakEvenMonth}` : "Not reached"} />
      </div>

      {/* Monthly Projections */}
      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8">
        <h3 className="text-xl font-bold mb-4">Monthly Projections</h3>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead>
              <tr className="border-b dark:border-gray-700">
                <th className="text-left py-2">Month</th>
                <th className="text-right py-2">Users</th>
                <th className="text-right py-2">Revenue</th>
                <th className="text-right py-2">Costs</th>
                <th className="text-right py-2">Profit</th>
                <th className="text-right py-2">Cumulative</th>
              </tr>
            </thead>
            <tbody>
              {results.projections.map(proj => (
                <tr key={proj.month} className="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                  <td className="py-2">{proj.month}</td>
                  <td className="text-right">{proj.users.toLocaleString()}</td>
                  <td className="text-right">${(proj.revenue / 1000).toFixed(1)}k</td>
                  <td className="text-right">${(proj.costs / 1000).toFixed(1)}k</td>
                  <td className={`text-right ${proj.profit >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                    ${(proj.profit / 1000).toFixed(1)}k
                  </td>
                  <td className={`text-right font-semibold ${proj.cumulativeProfit >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                    ${(proj.cumulativeProfit / 1000).toFixed(1)}k
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {/* Risk Analysis */}
      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8">
        <h3 className="text-xl font-bold mb-4">Risk Analysis</h3>
        <div className="space-y-4">
          {results.riskFactors.map((risk, idx) => (
            <div key={idx}>
              <div className="flex justify-between mb-2">
                <span className="font-medium">{risk.factor}</span>
                <span className="text-sm">
                  {risk.score}/100 â€¢ <span className={
                    risk.impact === "Low" ? "text-green-600" :
                    risk.impact === "Medium" ? "text-orange-600" :
                    "text-red-600"
                  }>{risk.impact} Impact</span>
                </span>
              </div>
              <div className="w-full bg-gray-200 rounded-full h-2">
                <div 
                  className={`h-2 rounded-full ${
                    risk.score >= 70 ? "bg-green-500" :
                    risk.score >= 50 ? "bg-orange-500" :
                    "bg-red-500"
                  }`}
                  style={{ width: `${risk.score}%` }}
                />
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Suggestions */}
      {results.suggestions.length > 0 && (
        <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8">
          <h3 className="text-xl font-bold mb-4">Recommendations</h3>
          <ul className="space-y-2">
            {results.suggestions.map((suggestion, idx) => (
              <li key={idx} className="flex gap-3">
                <span className="text-purple-600 font-bold">â€¢</span>
                <span>{suggestion}</span>
              </li>
            ))}
          </ul>
        </div>
      )}

      {/* Export Button */}
      <div className="text-center">
        <button
          onClick={generatePDF}
          disabled={isGeneratingPDF}
          className="bg-purple-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-purple-700 transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {isGeneratingPDF ? "Generating PDF..." : "ðŸ“„ Export PDF Report"}
        </button>
      </div>
    </div>
  );
}

function MetricCard({ title, value, trend }: { title: string; value: string; trend?: boolean }) {
  return (
    <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
      <div className="text-sm text-gray-600 dark:text-gray-400 mb-1">{title}</div>
      <div className={`text-2xl font-bold ${
        trend !== undefined ? (trend ? 'text-green-600' : 'text-red-600') : ''
      }`}>
        {value}
      </div>
    </div>
  );
}
